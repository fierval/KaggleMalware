open System
open System.Linq
open System.IO
open System.Collections.Generic

let files = Directory.GetFiles(@"h:\kaggle\malware\train", "*.bytes")
let outPath = @"c:\kaggle\malware\train"

if not (Directory.Exists outPath) then Directory.CreateDirectory outPath |> ignore
else 
    Directory.Delete(outPath, true)
    Directory.CreateDirectory outPath |> ignore

for f in files do
    let bytes = 
        File.ReadLines(f)
            .SelectMany(
                fun l -> 
                    l.Split([|' '|], 2)
                        .Last()
                        .Split(' ')
                        .Where(fun s -> System.Char.IsLetterOrDigit(s.[0]) && System.Char.IsLetterOrDigit(s.[1]))
                        .Select(fun s -> Convert.ToByte(s, 16)))
            .ToArray()
    
    let outF = Path.ChangeExtension(Path.Combine(outPath, Path.GetFileName(f)), ".bin")
    File.WriteAllBytes(outF, bytes)